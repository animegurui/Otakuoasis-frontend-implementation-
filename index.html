<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OtakuOasis ðŸŒ™</title>
  <style>
    body {
      margin:0;
      font-family:Arial, sans-serif;
      background:#0f0f0f;
      color:#fff;
      text-align:center;
    }
    header {
      background:#1a1a1a;
      padding:1rem;
      font-size:1.5rem;
      font-weight:bold;
    }
    #search {
      width:80%;
      max-width:500px;
      padding:0.5rem;
      margin:1rem auto;
      display:block;
      border-radius:5px;
      border:none;
      font-size:1rem;
    }
    .anime-list {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:1rem;
      padding:1rem;
    }
    .anime-card {
      background:#1f1f1f;
      padding:0.5rem;
      border-radius:10px;
      cursor:pointer;
      transition:transform 0.2s;
    }
    .anime-card:hover {
      transform:scale(1.05);
    }
    .anime-card img {
      width:100%;
      border-radius:10px;
    }
    /* Modal */
    #animeModal {
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:#000c;
      justify-content:center; align-items:center;
      z-index:1000;
    }
    #animeModal .content {
      background:#1a1a1a;
      padding:1rem;
      border-radius:10px;
      max-width:800px;
      width:90%;
    }
    #player {
      width:100%;
      height:400px;
      background:#000;
      margin-bottom:1rem;
    }
    .episodeBtn {
      margin:0.2rem;
      padding:0.3rem 0.6rem;
      border:none;
      border-radius:5px;
      cursor:pointer;
      background:#333;
      color:#fff;
    }
    .episodeBtn:hover {
      background:#ff4500;
    }
    /* Auth Modal */
    #authModal {
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:#000a;
      justify-content:center; align-items:center;
      z-index:2000;
    }
    #authModal .box {
      background:#1f1f1f;
      padding:2rem;
      border-radius:10px;
      width:300px;
      text-align:center;
    }
    #authModal input {
      width:100%;
      padding:0.5rem;
      margin:0.5rem 0;
      border-radius:5px;
      border:none;
    }
    #authModal button {
      background:#ff4500;
      color:#fff;
      border:none;
      padding:0.5rem 1rem;
      margin:0.5rem;
      border-radius:5px;
      cursor:pointer;
    }
    footer {
      margin-top:2rem;
      padding:1rem;
      font-size:0.9rem;
      color:#aaa;
    }
  </style>
</head>
<body>
  <header>ðŸŒ™ OtakuOasis</header>
  
  <input id="search" placeholder="Search for anime...">

  <h2>ðŸ”¥ Trending Anime</h2>
  <div id="trending" class="anime-list">Loading...</div>

  <!-- Anime Modal -->
  <div id="animeModal">
    <div class="content">
      <button onclick="closeAnimeModal()" style="float:right;background:#f00;color:#fff;border:none;padding:0.3rem 0.6rem;border-radius:5px;">X</button>
      <div id="player"></div>
      <button id="nextBtn" style="display:none;background:#ff4500;color:#fff;border:none;padding:0.5rem 1rem;margin-bottom:1rem;border-radius:5px;">Next Episode â–¶</button>
      <div id="episodes"></div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authModal">
    <div class="box">
      <h2 id="authTitle">Login</h2>
      <input id="username" placeholder="Username">
      <input id="password" type="password" placeholder="Password">
      <button id="authBtn">Login</button>
      <p id="toggleAuth" style="cursor:pointer;color:#00f;">No account? Sign up</p>
    </div>
  </div>

  <footer>Â© 2025 OtakuOasis</footer>

  <script>
    const API_BASE = "https://gogoanime.consumet.org";
    let currentUser = null;
    let currentEpisodes = [];
    let currentIndex = 0;

    const trendingDiv = document.getElementById("trending");
    const searchInput = document.getElementById("search");
    const modal = document.getElementById("animeModal");
    const player = document.getElementById("player");
    const episodeListDiv = document.getElementById("episodes");
    const nextBtn = document.getElementById("nextBtn");

    async function loadTrending(){
      try{
        const res=await fetch(`${API_BASE}/popular`);
        const data=await res.json();
        trendingDiv.innerHTML="";
        data.forEach(anime=>{
          const card=document.createElement("div");
          card.className="anime-card";
          card.innerHTML=`<img src="${anime.animeImg}" alt=""><p>${anime.animeTitle}</p>`;
          card.onclick=()=>openAnimeModal(anime.animeId, anime.animeTitle);
          trendingDiv.appendChild(card);
        });
      }catch(err){
        trendingDiv.innerHTML="Failed to load trending anime.";
      }
    }

    searchInput.addEventListener("keyup",async(e)=>{
      if(e.key==="Enter"){
        const q=searchInput.value.trim();
        if(!q) return;
        try{
          const res=await fetch(`${API_BASE}/search?keyw=${q}`);
          const data=await res.json();
          trendingDiv.innerHTML="";
          data.forEach(anime=>{
            const card=document.createElement("div");
            card.className="anime-card";
            card.innerHTML=`<img src="${anime.animeImg}" alt=""><p>${anime.animeTitle}</p>`;
            card.onclick=()=>openAnimeModal(anime.animeId, anime.animeTitle);
            trendingDiv.appendChild(card);
          });
        }catch(err){
          trendingDiv.innerHTML="Search failed.";
        }
      }
    });

    function closeAnimeModal(){
      modal.style.display="none";
      player.innerHTML="";
    }

    async function openAnimeModal(animeId, animeTitle){
      if(!currentUser){
        alert("You must login to watch anime!");
        return openAuthModal();
      }
      modal.style.display="flex";
      episodeListDiv.innerHTML="Loading episodes...";
      nextBtn.style.display="none";

      try{
        const res=await fetch(`${API_BASE}/anime-details/${animeId}`);
        const data=await res.json();
        if(data.episodes && data.episodes.length>0){
          currentEpisodes=data.episodes;
          let users=JSON.parse(localStorage.getItem("users")||"{}");
          let savedIndex=users[currentUser].progress[animeTitle] || 0;
          currentIndex=savedIndex;
          loadEpisode(currentIndex, animeTitle);

          episodeListDiv.innerHTML="";
          data.episodes.forEach((ep,i)=>{
            const btn=document.createElement("button");
            btn.className="episodeBtn";
            btn.textContent=ep.episodeNum;
            btn.onclick=()=>{currentIndex=i; loadEpisode(i, animeTitle)};
            episodeListDiv.appendChild(btn);
          });
        }
      }catch(err){
        episodeListDiv.innerHTML="Failed to load episodes.";
      }
    }

    function loadEpisode(index, animeTitle){
      const epUrl=currentEpisodes[index].episodeUrl;
      player.innerHTML=`<iframe src="https://gogoanime.pe/streaming.php?id=${epUrl.split('/')[2]}" width="100%" height="100%" frameborder="0" allowfullscreen></iframe>`;
      nextBtn.style.display=(index<currentEpisodes.length-1)?"inline-block":"none";

      let users=JSON.parse(localStorage.getItem("users")||"{}");
      users[currentUser].progress[animeTitle]=index;
      localStorage.setItem("users",JSON.stringify(users));
    }

    nextBtn.onclick=()=>{ if(currentIndex<currentEpisodes.length-1){ currentIndex++; loadEpisode(currentIndex); } };

    // ==== AUTH ====
    let isLoginMode=true;
    function openAuthModal(){ document.getElementById("authModal").style.display="flex"; }
    function closeAuthModal(){ document.getElementById("authModal").style.display="none"; }

    document.getElementById("authBtn").onclick=()=>{
      const username=document.getElementById("username").value.trim();
      const password=document.getElementById("password").value.trim();
      if(!username||!password) return alert("Enter username & password");

      let users=JSON.parse(localStorage.getItem("users")||"{}");

      if(isLoginMode){
        if(users[username] && users[username].password===password){
          currentUser=username;
          alert("Welcome back, "+username);
          closeAuthModal();
        }else{
          alert("Invalid credentials");
        }
      }else{
        if(users[username]){
          alert("User already exists");
        }else{
          users[username]={password,progress:{}};
          localStorage.setItem("users",JSON.stringify(users));
          alert("Account created! Please log in.");
          isLoginMode=true;
          document.getElementById("authTitle").textContent="Login";
          document.getElementById("authBtn").textContent="Login";
          document.getElementById("toggleAuth").textContent="No account? Sign up";
        }
      }
    };

    document.getElementById("toggleAuth").onclick=()=>{
      isLoginMode=!isLoginMode;
      document.getElementById("authTitle").textContent=isLoginMode?"Login":"Sign Up";
      document.getElementById("authBtn").textContent=isLoginMode?"Login":"Sign Up";
      document.getElementById("toggleAuth").textContent=isLoginMode?"No account? Sign up":"Already have an account? Login";
    };

    loadTrending();
  </script>
</body>
</html>
