<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Anime Details - OtakuOasis</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={darkMode:'class'}</script>
</head>
<body class="bg-gray-900 text-white font-sans">

<!-- Navbar -->
<header class="sticky top-0 bg-gray-950 shadow-lg z-50 p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold text-purple-400"><a href="index.html">OtakuOasis</a></h1>
  <div class="flex items-center gap-4">
    <input type="text" id="searchInput" placeholder="Search anime..." class="px-3 py-2 rounded-lg text-gray-900 focus:outline-none">
    <button onclick="openAuthModal()" class="px-3 py-2 bg-purple-500 rounded-lg hover:bg-purple-600 transition">Login / Sign Up</button>
    <button id="themeToggle" class="px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">üåô</button>
  </div>
</header>

<main class="max-w-6xl mx-auto p-6">
  <div id="animeDetails" class="opacity-0 transition-opacity duration-700"></div>

  <section id="relatedSection" class="mt-12 hidden">
    <h2 class="text-2xl font-bold text-purple-400 mb-6">Related Anime</h2>
    <div id="relatedGrid" class="flex gap-4 overflow-x-auto pb-4"></div>
  </section>
</main>

<footer class="bg-gray-950 py-6 text-center text-gray-400">
  &copy; <span id="year"></span> OtakuOasis
</footer>

<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
  <div class="bg-gray-800 p-6 rounded-2xl w-96 max-w-full relative">
    <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-white">‚úï</button>

    <div id="loginFormContainer">
      <h2 class="text-2xl font-bold text-purple-400 mb-4 text-center">Login</h2>
      <form id="loginForm" class="space-y-4">
        <input type="email" id="loginEmail" placeholder="Email" required class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
        <input type="password" id="loginPassword" placeholder="Password" required class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg font-semibold transition">Log In</button>
      </form>
      <p class="text-gray-400 mt-4 text-center text-sm">Don't have an account? <span id="showSignup" class="text-purple-400 cursor-pointer hover:underline">Sign up</span></p>
    </div>

    <div id="signupFormContainer" class="hidden">
      <h2 class="text-2xl font-bold text-purple-400 mb-4 text-center">Sign Up</h2>
      <form id="signupForm" class="space-y-4">
        <input type="text" id="signupUsername" placeholder="Username" required class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
        <input type="email" id="signupEmail" placeholder="Email" required class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
        <input type="password" id="signupPassword" placeholder="Password" required class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
        <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 px-4 py-2 rounded-lg font-semibold transition">Sign Up</button>
      </form>
      <p class="text-gray-400 mt-4 text-center text-sm">Already have an account? <span id="showLogin" class="text-purple-400 cursor-pointer hover:underline">Log in</span></p>
    </div>

    <p id="authMessage" class="text-center mt-4 text-sm"></p>
  </div>
</div>

<script>
const API_BASE="https://animegurui-otakuoasis.onrender.com/api";
document.getElementById("year").textContent = new Date().getFullYear();

// Dark mode
const themeToggle=document.getElementById("themeToggle");
const userTheme=localStorage.getItem("theme");
if(userTheme==="dark"||!userTheme){document.documentElement.classList.add("dark"); themeToggle.textContent="üåô";}
else{document.documentElement.classList.remove("dark"); themeToggle.textContent="‚òÄÔ∏è";}
themeToggle.addEventListener("click",()=>{
  document.documentElement.classList.toggle("dark");
  const isDark=document.documentElement.classList.contains("dark");
  localStorage.setItem("theme",isDark?"dark":"light");
  themeToggle.textContent=isDark?"üåô":"‚òÄÔ∏è";
});

// Search bar
const searchInput=document.getElementById("searchInput");
searchInput.addEventListener("keypress",e=>{
  if(e.key==="Enter" && searchInput.value.trim()){
    window.location.href=`anime.html?search=${encodeURIComponent(searchInput.value.trim())}`;
  }
});

// Auth modal
const authModal=document.getElementById("authModal");
const closeModal=document.getElementById("closeModal");
const loginFormContainer=document.getElementById("loginFormContainer");
const signupFormContainer=document.getElementById("signupFormContainer");
const showSignup=document.getElementById("showSignup");
const showLogin=document.getElementById("showLogin");
const authMessage=document.getElementById("authMessage");
function openAuthModal(){authModal.classList.remove("hidden");}
closeModal.addEventListener("click",()=>authModal.classList.add("hidden"));
showSignup.addEventListener("click",()=>{loginFormContainer.classList.add("hidden"); signupFormContainer.classList.remove("hidden"); authMessage.textContent="";});
showLogin.addEventListener("click",()=>{signupFormContainer.classList.add("hidden"); loginFormContainer.classList.remove("hidden"); authMessage.textContent="";});

// Login
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  authMessage.textContent="Logging in..."; authMessage.className="text-center mt-4 text-gray-400";
  try{
    const res=await fetch(`${API_BASE}/auth/login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({email:document.getElementById("loginEmail").value,password:document.getElementById("loginPassword").value})
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.message||"Login failed");
    localStorage.setItem("token",data.token);
    authMessage.textContent="‚úÖ Login successful!"; authMessage.className="text-center mt-4 text-green-400";
    setTimeout(()=>authModal.classList.add("hidden"),1000);
  }catch(err){authMessage.textContent="‚ùå "+err.message; authMessage.className="text-center mt-4 text-red-400";}
});

// Signup
document.getElementById("signupForm").addEventListener("submit", async e=>{
  e.preventDefault();
  authMessage.textContent="Creating account..."; authMessage.className="text-center mt-4 text-gray-400";
  try{
    const res=await fetch(`${API_BASE}/auth/register`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        username:document.getElementById("signupUsername").value,
        email:document.getElementById("signupEmail").value,
        password:document.getElementById("signupPassword").value
      })
    });
    const data=await res.json();
    if(!res.ok) throw new Error(data.message||"Signup failed");
    authMessage.textContent="‚úÖ Account created!"; authMessage.className="text-center mt-4 text-green-400";
    setTimeout(()=>{signupFormContainer.classList.add("hidden"); loginFormContainer.classList.remove("hidden"); authMessage.textContent="";},1500);
  }catch(err){authMessage.textContent="‚ùå "+err.message; authMessage.className="text-center mt-4 text-red-400";}
});

// Get anime ID or search query from URL
const params=new URLSearchParams(window.location.search);
const animeId=params.get("id");
const searchQuery=params.get("search");
const container=document.getElementById("animeDetails");

// Load anime details or search results
async function loadAnime(){
  if(searchQuery){
    // Search mode
    container.innerHTML="<p class='text-gray-400 mb-4'>Search results for '"+searchQuery+"'</p>";
    await fetchAnime(`anime/search?query=${encodeURIComponent(searchQuery)}`,"animeDetails");
    return;
  }
  if(!animeId){container.innerHTML="<p class='text-red-400'>Anime not found.</p>"; return;}
  try{
    const res=await fetch(`${API_BASE}/anime/${animeId}`);
    if(!res.ok) throw new Error();
    const anime=await res.json();
    container.innerHTML=`
      <div class="flex flex-col md:flex-row gap-6">
        <img src="${anime.image||'https://via.placeholder.com/300x450?text=No+Image'}" alt="${anime.title}" class="w-full md:w-1/3 rounded-xl shadow-lg">
        <div class="flex-1">
          <h1 class="text-4xl font-bold text-purple-400 mb-4">${anime.title}</h1>
          <p class="text-gray-300 mb-4">${anime.description||"No description available."}</p>
          <p class="text-gray-400 mb-2"><strong>Episodes:</strong> ${anime.episode||"?"}</p>
          <p class="text-gray-400 mb-4"><strong>Status:</strong> ${anime.status||"Unknown"}</p>
          <a href="${anime.streamUrl||'#'}" class="inline-block bg-purple-500 hover:bg-purple-600 px-6 py-3 rounded-xl transition">‚ñ∂ Watch Now</a>
        </div>
      </div>
    `;
    container.classList.add("opacity-100");
    loadRelated(animeId);
  }catch{container.innerHTML="<p class='text-red-400'>Failed to load anime details.</p>";}
}

// Load related anime
async function loadRelated(animeId){
  const section=document.getElementById("relatedSection");
  const grid=document.getElementById("relatedGrid");
  try{
    const res=await fetch(`${API_BASE}/anime/${animeId}/related`);
    if(!res.ok) throw new Error();
    const related=await res.json();
    if(!related.length) return;
    grid.innerHTML="";
    related.forEach(a=>{
      const card=document.createElement("div");
      card.className="min-w-[150px] flex-shrink-0 bg-gray-800 rounded-xl overflow-hidden shadow-md hover:scale-105 transition cursor-pointer";
      card.innerHTML=`<img src="${a.image||'https://via.placeholder.com/150x225?text=?'}" alt="${a.title}" class="w-full h-36 object-cover"><div class="p-2"><p class="text-sm font-semibold">${a.title}</p><p class="text-gray-400 text-xs">Ep ${a.episode||"?"}</p></div>`;
      card.addEventListener("click",()=> window.location.href=`anime.html?id=${a._id||a.id}`);
      grid.appendChild(card);
    });
    section.classList.remove("hidden");
  }catch{ console.error("Failed to load related anime."); }
}

loadAnime();
</script>
</body>
</html>
